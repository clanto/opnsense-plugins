{% from 'OPNsense/Macros/interface.macro' import physical_interface %}

{% if helpers.exists('OPNsense.maltrail.server.enabled') and OPNsense.maltrail.server.enabled == '1' %}

# [Server]
HTTP_ADDRESS {{ OPNsense.maltrail.server.listenaddress }}
HTTP_PORT {{ OPNsense.maltrail.server.listenport }}

{%   if helpers.exists('OPNsense.maltrail.server.ssl') and OPNsense.maltrail.server.ssl == '1' %}
USE_SSL true
SSL_PEM {{ OPNsense.maltrail.server.sslcert }}
{%   else %}
USE_SSL false
{%   endif %}

USERS
    admin:{{ OPNsense.maltrail.server.adminpassword }}:2000:0.0.0.0/0                        # changeme!
	
{%   if helpers.exists('OPNsense.maltrail.server.maskcustom') and OPNsense.maltrail.server.maskcustom == '1' %}
ENABLE_MASK_CUSTOM true
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.server.loglistenaddress') and OPNsense.maltrail.server.loglistenaddress != '' %}
UDP_ADDRESS {{ OPNsense.maltrail.server.loglistenaddress }}
{%   endif %}
{%   if helpers.exists('OPNsense.maltrail.server.loglistenport') and OPNsense.maltrail.server.loglistenport != '' %}
UDP_PORT {{ OPNsense.maltrail.server.loglistenport }}
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.server.updatetrails') and OPNsense.maltrail.server.updatetrails == '1' %}
USE_SERVER_UPDATE_TRAILS true
{%   else %}
USE_SERVER_UPDATE_TRAILS false
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.server.ipaliases') and OPNsense.maltrail.server.ipaliases != '' %}
{%      for item in OPNsense.maltrail.server.ipaliases.split(',') %}
{{     item|trim }}
{%      endfor %}
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.server.fail2banregex') and OPNsense.maltrail.server.fail2banregex != '' %}
FAIL2BAN_REGEX {{ OPNsense.maltrail.server.fail2banregex }}
{%   else %}
FAIL2BAN_REGEX attacker|reputation|potential[^"]*(web scan|directory traversal|injection|remote code)|spammer|mass scanner
{%   endif %}
{% endif %}

{% if helpers.exists('OPNsense.maltrail.sensor.enabled') and OPNsense.maltrail.sensor.enabled == '1' %}
# [Sensor]
PROCESS_COUNT {{ OPNsense.maltrail.sensor.processcount }}

{%   if helpers.exists('OPNsense.maltrail.sensor.disablecpuaffinity') and OPNsense.maltrail.sensor.disablecpuaffinity == '1' %}
DISABLE_CPU_AFFINITY true
{%   else %}
DISABLE_CPU_AFFINITY false
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.usefeedupdates') and OPNsense.maltrail.sensor.sensor.usefeedupdates == '1' %}
USE_FEED_UPDATES true
{%   else %}
USE_FEED_UPDATES false
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.disablefeeds') and OPNsense.maltrail.sensor.disablefeeds != '' %}
DISABLED_FEEDS {{ OPNsense.maltrail.sensor.disablefeeds }}
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.ipminimumfeeds') and OPNsense.maltrail.sensor.ipminimumfeeds != '' %}
IP_MINIMUM_FEEDS {{ OPNsense.maltrail.sensor.ipminimumfeeds }}
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.disabledtrailsinforegex') and OPNsense.maltrail.sensor.disabledtrailsinforegex != '' %}
DISABLED_TRAILS_INFO_REGEX {{ OPNsense.maltrail.sensor.disabledtrailsinforegex }}
{%   endif %}

UPDATE_PERIOD {{ OPNsense.maltrail.general.updateperiod }}

{%   if helpers.exists('OPNsense.maltrail.sensor.customtrailsurl') and OPNsense.maltrail.sensor.customtrailsurl != '' %}
CUSTOM_TRAILS_URL {{ OPNsense.maltrail.sensor.customtrailsurl }}
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.customtrails') and OPNsense.maltrail.sensor.customtrails != '' %}
CUSTOM_TRAILS_DIR /usr/local/share/maltrail/trails/custom
{%   endif %}

{%   if helpers.empty('OPNsense.maltrail.sensor.capturebuffer') %}
CAPTURE_BUFFER 10%
{%   else %}
CAPTURE_BUFFER {{OPNsense.maltrail.sensor.capturebuffer}}MB
{%    endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.monitorinterface') and OPNsense.maltrail.sensor.monitorinterface != '' %}
{%      set interfaces = [] %}
{%      for interface in OPNsense.maltrail.sensor.monitorinterface.split(',') %}
{%     do interfaces.append(physical_interface(interface)) %}
{%      endfor %}
MONITOR_INTERFACE {{ interfaces|join(',') }}
{%   else %}
MONITOR_INTERFACE any
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.captureall') and OPNsense.maltrail.sensor.captureall == '1' %}
CAPTURE_FILTER ip or ip6
{%   else %}
CAPTURE_FILTER udp or icmp or (tcp and (tcp[tcpflags] == tcp-syn or port 80 or port 1080 or port 3128 or port 8000 or port 8080 or port 8118))
{%   endif %}

{%   if helpers.empty('OPNsense.maltrail.sensor.name') %}
SENSOR_NAME $HOSTNAME
{%   else %}
SENSOR_NAME {{OPNsense.maltrail.sensor.name}}MB
{%    endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.remoteserver') and OPNsense.maltrail.sensor.remoteserver != '' %}
LOG_SERVER {{ OPNsense.maltrail.sensor.remoteserver }}:{{ OPNsense.maltrail.sensor.remoteport }}
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.syslogserver') and OPNsense.maltrail.sensor.syslogserver != '' %}
SYSLOG_SERVER {{ OPNsense.maltrail.sensor.syslogserver }}:{{ OPNsense.maltrail.sensor.syslogport }}
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.logstashserver') and OPNsense.maltrail.sensor.logstashserver != '' %}
SYSLOG_SERVER {{ OPNsense.maltrail.sensor.logstashserver }}:{{ OPNsense.maltrail.sensor.logstashport }}
{%   endif %}

{%   if helpers.empty('OPNsense.maltrail.sensor.remoteseverityregex') %}
REMOTE_SEVERITY_REGEX (?P<high>(remote )?custom\)|malwaredomainlist|malware(?! (distribution|site))|adversary|ransomware)|(?P<medium>potential malware site|malware distribution)|(?P<low>mass scanner|reputation|attacker|spammer|compromised|crawler|scanning)
{%   else %}
REMOTE_SEVERITY_REGEX {{OPNsense.maltrail.sensor.remoteseverityregex}}
{%    endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.disablelocallog') and OPNsense.maltrail.sensor.disablelocallog == '1' %}
DISABLE_LOCAL_LOG_STORAGE true
{%   else %}
DISABLE_LOCAL_LOG_STORAGE false
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.updateserver') and OPNsense.maltrail.sensor.updateserver != '' %}
UPDATE_SERVER {{OPNsense.maltrail.sensor.updateserver}}
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.heuristics') and OPNsense.maltrail.sensor.heuristics == '1' %}
USE_HEURISTICS true
{%   else %}
USE_HEURISTICS false
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.checkmissinghost') and OPNsense.maltrail.sensor.checkmissinghost == '1' %}
CHECK_MISSING_HOST true
{%   else %}
CHECK_MISSING_HOST false
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.checkhostheader') and OPNsense.maltrail.sensor.checkhostheader == '1' %}
CHECK_HOST_DOMAINS true
{%   else %}
CHECK_HOST_DOMAINS false
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.whitelist') and OPNsense.maltrail.sensor.whitelist != '' %}
USER_WHITELIST /usr/local/share/maltrail/misc/user_whitelist.txt
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.ignorelist') and OPNsense.maltrail.sensor.ignorelist != '' %}
USER_IGNORELIST /usr/local/share/maltrail/misc/user_ignorelist.txt
{%   endif %}

{%   if helpers.exists('OPNsense.maltrail.sensor.ignoreeventsregex
') and OPNsense.maltrail.sensor.ignoreeventsregex
 != '' %}
IGNORE_EVENTS_REGEX {{OPNsense.maltrail.sensor.ignoreeventsregex}}
{%   endif %}
{% endif %}

# [All]

{% if helpers.exists('OPNsense.maltrail.general.showdebug') and OPNsense.maltrail.general.showdebug == '1' %}
SHOW_DEBUG true
{% else %}
SHOW_DEBUG false
{% endif %}

{% if helpers.exists('OPNsense.maltrail.general.logdir') and OPNsense.maltrail.general.logdir != '' %}
LOG_DIR {{OPNsense.maltrail.general.logdir}}
{% else %}
LOG_DIR /var/log/maltrail
{% endif %}

{% if helpers.exists('OPNsense.maltrail.general.proxyaddress') and OPNsense.maltrail.general.proxyaddress != '' %}
PROXY_ADDRESS {{OPNsense.maltrail.general.proxyaddress}}:{{OPNsense.maltrail.general.proxyport}}
{% endif %}

{% if helpers.exists('OPNsense.maltrail.general.disablechecksudo') and OPNsense.maltrail.general.disablechecksudo == '1' %}
DISABLE_CHECK_SUDO true
{% endif %}

{% if helpers.exists('OPNsense.maltrail.general.trailsfile') and OPNsense.maltrail.general.trailsfile != '' %}
TRAILS_FILE {{OPNsense.maltrail.general.trailsfile}}
{% endif %}


